# Socket.io 媒体控制接口

本文档定义了通过 Socket.io 实现大屏媒体控制功能的接口规范，包括视频、音频和图片等媒体内容的播放控制。通过这些接口，可以实现对大屏显示内容的远程控制，支持教学演示、内容展示等多种应用场景。

当前日期：2025年4月16日  
文档版本：1.0  

---

## 目录

- [Socket.io 媒体控制接口](#socketio-媒体控制接口)
  - [目录](#目录)
  - [1. 接口概述](#1-接口概述)
    - [1.1 功能简介](#11-功能简介)
    - [1.2 服务地址](#12-服务地址)
  - [2. 连接参数](#2-连接参数)
  - [3. 视频控制](#3-视频控制)
    - [3.1 播放视频](#31-播放视频)
    - [3.2 暂停视频](#32-暂停视频)
    - [3.3 继续播放](#33-继续播放)
    - [3.4 停止播放](#34-停止播放)
    - [3.5 调整播放进度](#35-调整播放进度)
    - [3.6 调整音量](#36-调整音量)
    - [3.7 视频播放状态反馈](#37-视频播放状态反馈)
  - [4. 音频控制](#4-音频控制)
    - [4.1 播放音频](#41-播放音频)
    - [4.2 暂停音频](#42-暂停音频)
    - [4.3 继续播放](#43-继续播放)
    - [4.4 停止播放](#44-停止播放)
    - [4.5 调整播放进度](#45-调整播放进度)
    - [4.6 调整音量](#46-调整音量)
    - [4.7 音频播放状态反馈](#47-音频播放状态反馈)
  - [5. 图片控制](#5-图片控制)
    - [5.1 显示图片](#51-显示图片)
    - [5.2 切换图片](#52-切换图片)
    - [5.3 轮播图片](#53-轮播图片)
    - [5.4 关闭图片显示](#54-关闭图片显示)
  - [6. 网页控制](#6-网页控制)
    - [6.1 打开网页](#61-打开网页)
    - [6.2 刷新网页](#62-刷新网页)
    - [6.3 关闭网页](#63-关闭网页)
    - [6.4 模拟交互](#64-模拟交互)
  - [7. 综合媒体控制](#7-综合媒体控制)
    - [7.1 清除所有媒体](#71-清除所有媒体)
    - [7.2 媒体布局控制](#72-媒体布局控制)
    - [7.3 多媒体同步播放](#73-多媒体同步播放)
  - [8. 使用示例](#8-使用示例)
    - [8.1 客户端发送控制命令](#81-客户端发送控制命令)
    - [8.2 服务端广播控制命令](#82-服务端广播控制命令)
    - [8.3 完整控制流程](#83-完整控制流程)
  - [9. 注意事项](#9-注意事项)
  - [10. 更新日志](#10-更新日志)
    - [v1.0 (2025年4月16日)](#v10-2025年4月16日)

---

## 1. 接口概述

### 1.1 功能简介

媒体控制接口允许远程控制大屏显示不同类型的媒体内容，主要包括：

- **视频控制**：播放、暂停、停止、调整进度和音量等
- **音频控制**：播放、暂停、停止、调整进度和音量等
- **图片控制**：显示、切换、轮播等
- **网页控制**：打开、刷新、关闭等
- **综合媒体控制**：媒体布局调整、多媒体同步等

### 1.2 服务地址

Socket.io 服务地址：`wss://gs.classtao.cn/all`

## 2. 连接参数

建立 Socket.io 连接时，需要提供以下参数：

```javascript
const socket = io("wss://gs.classtao.cn/all", {
  query: {
    roomId: "教室ID或会议室ID",  // 必填，指定控制的目标房间
    type: "controller",          // 必填，指定角色类型：controller(控制端) 或 screen(显示端)
    token: "认证令牌",           // 可选，用于身份验证
    device_id: "设备唯一标识"    // 可选，用于标识控制设备
  },
  transports: ["websocket"]
});
```

## 3. 视频控制

### 3.1 播放视频

**客户端发送**：

```json
{
  "action": "play_video",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "url": "https://example.com/video.mp4",
    "title": "示例视频",
    "autoplay": true,
    "loop": false,
    "volume": 0.8,
    "position": "fullscreen",  // fullscreen, center, top-left, custom
    "width": 1920,             // 仅当position为custom时有效
    "height": 1080,            // 仅当position为custom时有效
    "x": 0,                    // 仅当position为custom时有效
    "y": 0,                    // 仅当position为custom时有效
    "start_time": 0,           // 开始播放的时间点(秒)
    "play_id": "vid_12345"     // 可选，视频播放的唯一标识，用于后续控制
  }
}
```

**服务端响应**：

```json
{
  "action": "play_video_response",
  "from": "server",
  "to": ["controller_id"],
  "time": 1691652123789,
  "status": "success",
  "message": "视频播放指令已发送",
  "data": {
    "play_id": "vid_12345",     // 视频播放的唯一标识
    "target_screens": ["screen_id"]
  }
}
```

### 3.2 暂停视频

**客户端发送**：

```json
{
  "action": "pause_video",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "play_id": "vid_12345"      // 要暂停的视频播放标识
  }
}
```

### 3.3 继续播放

**客户端发送**：

```json
{
  "action": "resume_video",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "play_id": "vid_12345"      // 要继续播放的视频标识
  }
}
```

### 3.4 停止播放

**客户端发送**：

```json
{
  "action": "stop_video",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "play_id": "vid_12345"      // 要停止的视频播放标识
  }
}
```

### 3.5 调整播放进度

**客户端发送**：

```json
{
  "action": "seek_video",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "play_id": "vid_12345",     // 视频播放标识
    "position": 120.5           // 目标播放位置(秒)
  }
}
```

### 3.6 调整音量

**客户端发送**：

```json
{
  "action": "set_video_volume",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "play_id": "vid_12345",     // 视频播放标识
    "volume": 0.5               // 音量级别(0.0-1.0)
  }
}
```

### 3.7 视频播放状态反馈

**服务端广播**：

```json
{
  "action": "broadcast_video_status",
  "from": "server",
  "to": ["controller_id"],
  "time": 1691652123456,
  "data": {
    "play_id": "vid_12345",
    "status": "playing",        // playing, paused, stopped, ended, buffering, error
    "current_time": 45.2,       // 当前播放位置(秒)
    "duration": 180.5,          // 视频总长度(秒)
    "volume": 0.8,              // 当前音量
    "error": null,              // 如果status为error，则包含错误信息
    "screen_id": "screen_id"    // 反馈状态的屏幕ID
  }
}
```

## 4. 音频控制

### 4.1 播放音频

**客户端发送**：

```json
{
  "action": "play_audio",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "url": "https://example.com/audio.mp3",
    "title": "示例音频",
    "autoplay": true,
    "loop": false,
    "volume": 0.8,
    "start_time": 0,           // 开始播放的时间点(秒)
    "play_id": "aud_12345"     // 可选，音频播放的唯一标识
  }
}
```

### 4.2 暂停音频

**客户端发送**：

```json
{
  "action": "pause_audio",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "play_id": "aud_12345"      // 要暂停的音频播放标识
  }
}
```

### 4.3 继续播放

**客户端发送**：

```json
{
  "action": "resume_audio",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "play_id": "aud_12345"      // 要继续播放的音频标识
  }
}
```

### 4.4 停止播放

**客户端发送**：

```json
{
  "action": "stop_audio",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "play_id": "aud_12345"      // 要停止的音频播放标识
  }
}
```

### 4.5 调整播放进度

**客户端发送**：

```json
{
  "action": "seek_audio",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "play_id": "aud_12345",     // 音频播放标识
    "position": 120.5           // 目标播放位置(秒)
  }
}
```

### 4.6 调整音量

**客户端发送**：

```json
{
  "action": "set_audio_volume",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "play_id": "aud_12345",     // 音频播放标识
    "volume": 0.5               // 音量级别(0.0-1.0)
  }
}
```

### 4.7 音频播放状态反馈

**服务端广播**：

```json
{
  "action": "broadcast_audio_status",
  "from": "server",
  "to": ["controller_id"],
  "time": 1691652123456,
  "data": {
    "play_id": "aud_12345",
    "status": "playing",        // playing, paused, stopped, ended, buffering, error
    "current_time": 45.2,       // 当前播放位置(秒)
    "duration": 180.5,          // 音频总长度(秒)
    "volume": 0.8,              // 当前音量
    "error": null,              // 如果status为error，则包含错误信息
    "screen_id": "screen_id"    // 反馈状态的屏幕ID
  }
}
```

## 5. 图片控制

### 5.1 显示图片

**客户端发送**：

```json
{
  "action": "show_image",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "url": "https://example.com/image.jpg",
    "title": "示例图片",
    "position": "fullscreen",  // fullscreen, center, top-left, custom
    "width": 1920,             // 仅当position为custom时有效
    "height": 1080,            // 仅当position为custom时有效
    "x": 0,                    // 仅当position为custom时有效
    "y": 0,                    // 仅当position为custom时有效
    "transition": "fade",      // none, fade, slide, zoom
    "duration": 5000,          // 显示持续时间(毫秒)，0表示永久显示
    "image_id": "img_12345"    // 可选，图片显示的唯一标识
  }
}
```

### 5.2 切换图片

**客户端发送**：

```json
{
  "action": "change_image",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "previous_image_id": "img_12345",  // 当前显示的图片ID
    "url": "https://example.com/new-image.jpg",
    "title": "新的图片",
    "position": "fullscreen",
    "transition": "slide",
    "duration": 0,
    "image_id": "img_67890"
  }
}
```

### 5.3 轮播图片

**客户端发送**：

```json
{
  "action": "slideshow_images",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "images": [
      {
        "url": "https://example.com/image1.jpg",
        "title": "图片1",
        "duration": 3000  // 显示时间(毫秒)
      },
      {
        "url": "https://example.com/image2.jpg",
        "title": "图片2",
        "duration": 5000
      },
      {
        "url": "https://example.com/image3.jpg",
        "title": "图片3",
        "duration": 4000
      }
    ],
    "position": "fullscreen",
    "transition": "fade",
    "loop": true,              // 是否循环播放
    "auto_start": true,        // 是否自动开始
    "slideshow_id": "ss_12345" // 轮播的唯一标识
  }
}
```

### 5.4 关闭图片显示

**客户端发送**：

```json
{
  "action": "close_image",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "image_id": "img_12345",     // 要关闭的图片ID
    // 或者
    "slideshow_id": "ss_12345"   // 要关闭的轮播ID
  }
}
```

## 6. 网页控制

### 6.1 打开网页

**客户端发送**：

```json
{
  "action": "open_webpage",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "url": "https://example.com",
    "title": "示例网页",
    "position": "fullscreen",  // fullscreen, center, custom
    "width": 1920,             // 仅当position为custom时有效
    "height": 1080,            // 仅当position为custom时有效
    "x": 0,                    // 仅当position为custom时有效
    "y": 0,                    // 仅当position为custom时有效
    "zoom": 1.0,               // 缩放比例
    "timeout": 30000,          // 加载超时时间(毫秒)
    "webpage_id": "web_12345"  // 网页显示的唯一标识
  }
}
```

### 6.2 刷新网页

**客户端发送**：

```json
{
  "action": "refresh_webpage",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "webpage_id": "web_12345",  // 要刷新的网页ID
    "clear_cache": false        // 是否清除缓存
  }
}
```

### 6.3 关闭网页

**客户端发送**：

```json
{
  "action": "close_webpage",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "webpage_id": "web_12345"   // 要关闭的网页ID
  }
}
```

### 6.4 模拟交互

**客户端发送**：

```json
{
  "action": "webpage_interaction",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "webpage_id": "web_12345",
    "interaction_type": "click", // click, scroll, input
    "selector": "#submit-button", // CSS选择器
    "value": "",                 // 对于input类型，输入的值
    "x": 100,                    // 点击坐标X(相对于网页)
    "y": 200                     // 点击坐标Y(相对于网页)
  }
}
```

## 7. 综合媒体控制

### 7.1 清除所有媒体

**客户端发送**：

```json
{
  "action": "clear_all_media",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "types": ["video", "audio", "image", "webpage"],  // 要清除的媒体类型
    "fade_out": true,                                 // 是否淡出效果
    "fade_duration": 500                              // 淡出持续时间(毫秒)
  }
}
```

### 7.2 媒体布局控制

**客户端发送**：

```json
{
  "action": "set_media_layout",
  "from": "controller_id",
  "to": ["screen_id"],
  "time": 1691652123456,
  "data": {
    "layout": "grid",         // grid, picture-in-picture, side-by-side, custom
    "items": [
      {
        "id": "vid_12345",    // 媒体ID
        "type": "video",      // 媒体类型
        "x": 0,               // 位置X(百分比或像素)
        "y": 0,               // 位置Y(百分比或像素)
        "width": "50%",       // 宽度(百分比或像素)
        "height": "50%",      // 高度(百分比或像素)
        "z_index": 1          // 层叠顺序
      },
      {
        "id": "img_67890",
        "type": "image",
        "x": "50%",
        "y": 0,
        "width": "50%",
        "height": "50%",
        "z_index": 2
      }
    ],
    "background_color": "#000000",  // 背景颜色
    "transition": "fade",           // 过渡效果
    "layout_id": "layout_12345"     // 布局唯一标识
  }
}
```

### 7.3 多媒体同步播放

**客户端发送**：

```json
{
  "action": "sync_media_playback",
  "from": "controller_id",
  "to": ["screen_id_1", "screen_id_2", "screen_id_3"],
  "time": 1691652123456,
  "data": {
    "command": "play",        // play, pause, seek
    "target_time": 15.5,      // 对于seek命令，指定目标时间(秒)
    "media_ids": ["vid_12345", "aud_67890"],  // 要同步的媒体ID列表
    "sync_group_id": "sync_12345"            // 同步组ID
  }
}
```

## 8. 使用示例

### 8.1 客户端发送控制命令

**示例代码**：

```javascript
// 建立连接
const socket = io("wss://gs.classtao.cn/all", {
  query: {
    roomId: "classroom_123",
    type: "controller",
    token: "user_auth_token"
  },
  transports: ["websocket"]
});

// 连接成功后
socket.on("connect", () => {
  console.log("已连接到Socket.io服务器");
  
  // 发送播放视频的消息
  socket.emit("message", {
    action: "play_video",
    from: socket.id,
    to: ["screen_abc"],
    time: Date.now(),
    data: {
      url: "https://example.com/educational_video.mp4",
      title: "教学视频",
      autoplay: true,
      loop: false,
      volume: 0.8,
      position: "fullscreen",
      play_id: "vid_" + Date.now()
    }
  });
});

// 接收视频状态反馈
socket.on("message", (message) => {
  if (message.action === "broadcast_video_status") {
    console.log("视频状态:", message.data.status);
    console.log("当前进度:", message.data.current_time);
    console.log("总时长:", message.data.duration);
  }
});
```

### 8.2 服务端广播控制命令

当一个控制端向服务器发送媒体控制命令时，服务器会将命令广播给相关的显示端：

```javascript
// 服务端代码示例（伪代码）
socket.on("message", (message) => {
  if (message.action === "play_video") {
    // 验证消息有效性
    if (isValidMessage(message)) {
      // 获取目标屏幕
      const targetScreens = message.to || [];
      
      // 广播命令到目标屏幕
      targetScreens.forEach(screenId => {
        const screenSocket = getSocketById(screenId);
        if (screenSocket) {
          screenSocket.emit("message", message);
        }
      });
      
      // 确认响应
      socket.emit("message", {
        action: "play_video_response",
        from: "server",
        to: [message.from],
        time: Date.now(),
        status: "success",
        message: "视频播放指令已发送",
        data: {
          play_id: message.data.play_id,
          target_screens: targetScreens
        }
      });
    }
  }
});
```

### 8.3 完整控制流程

1. **控制端连接服务器**
   - 控制端与 Socket.io 服务器建立连接
   - 设置 `type=controller` 参数

2. **显示端连接服务器**
   - 显示端与 Socket.io 服务器建立连接
   - 设置 `type=screen` 参数
   - 与控制端使用相同的 `roomId`

3. **控制端发送媒体控制命令**
   - 构建消息对象
   - 指定 `to` 字段为目标显示端 ID
   - 通过 `socket.emit("message", messageObject)` 发送

4. **服务器处理和转发**
   - 服务器验证消息格式和权限
   - 将消息转发给目标显示端
   - 向控制端发送确认响应

5. **显示端执行控制命令**
   - 显示端接收消息
   - 根据 `action` 字段执行相应操作
   - 播放、暂停、调整媒体内容

6. **显示端反馈状态**
   - 显示端定期或在状态变化时发送状态更新
   - 服务器将状态更新广播给控制端

## 9. 注意事项

1. **媒体资源访问**
   - 确保媒体资源URL可公开访问，或者显示端有权限访问
   - 对于需要认证的资源，可在URL中包含临时访问令牌
   - 支持的媒体格式取决于浏览器的支持情况

2. **媒体同步**
   - 多个显示端同步播放时，可能会因网络延迟产生轻微不同步
   - 建议使用NTP同步服务器和客户端时间
   - 周期性发送同步命令以修正漂移

3. **资源限制**
   - 显示端可能有内存和处理能力限制
   - 避免同时播放过多媒体内容
   - 高分辨率视频可能会影响性能

4. **网络要求**
   - 媒体控制需要稳定的网络连接
   - 视频和音频流可能需要较高带宽
   - 断线重连机制应恢复之前的媒体状态

5. **兼容性**
   - 不同浏览器对媒体格式的支持不同
   - 建议使用广泛支持的格式如H.264、AAC、JPEG等
   - 测试主流浏览器以确保兼容性

## 10. 更新日志

### v1.0 (2025年4月16日)
- 初始版本发布
- 支持视频、音频、图片和网页控制
- 提供媒体布局和同步播放功能
- 包含详细的接口定义和使用示例 